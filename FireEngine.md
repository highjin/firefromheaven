


---

一个小约定：
为了方便，将天火引擎的开发者简称为“开发者”，用天火引擎制作AVG游戏的用户简称为“制作者”，玩游戏者简称为“玩家”。

---


# 概述 #
天火引擎（Fire Engine）是一个正在开发的AVG引擎，使用C# + XNA实现。利用XML的便利实现了简洁的脚本系统及编辑器的代码提示和自动完成功能，还将致力于提供不同于传统AVG引擎的全新人机交互方式和视觉效果。
## 主要特点 ##
  1. 免费、开源。
  1. 简洁易懂的脚本设计；代码提示和自动完成；运行前脚本错误检查。
  1. 专为AVG设计，AVG常用元素，如背景、立绘、CG、选项框、音乐、音效、语音等均只需通过单一语句就能完成。
  1. 完善的图形系统，支持自定义动画。
  1. 利用DirectX实现多种转场效果和视觉特效。
  1. 架构设计尽量考虑今后的扩展性
## 游戏制作环境 ##
这里是指利用天火引擎制作AVG游戏所需的软件环境。
  * Visual C# 2008 Express（大约800M）
  * XNA Game Studio 3.1（大约80M）（需要以上两样东西的原因请见《目前的窘境》，今后将致力于脱离Visual C#)
  * DirectX 9
## 运行环境 ##
这里是指运行使用天火引擎制作的AVG游戏所需的软件环境。
  * .Net Framework 2.0（大约20M）
  * XNA Redistribution 3.1 （大约8M）
  * DirectX 9

# 天火脚本FireML #
天火脚本目前的样子大概是：
```
<?xml version="1.0" encoding="utf-8"?>
<FireML xmlns="http://www.jianyingstudio.org/schemas/FireML">
<MainPlot>
    <music src="music/music1.mp3"/>
    <solo/> 
    我讨厌这座小镇
    因为这里满是想要忘却的回忆
    <bg img="bg/bg1.jpg"/>
    每天去学校，听听课，与朋友们闲聊，然后回到根本不想回的家里
    没有任何新鲜的事物
    <tomoya/>（这样下去，会有什么改变吗…）
    （我的生活，今后会有什么改变吗？）

    <bg img="bg/bg2_sky_cloud.jpg"/>
    <actor name="声音"/>唉…
    <solo/>那是另一个人的叹息声。相比我而言，显得微弱而短促。
    我看了看旁边。

    <music src="music/music2.mp3"/>
    <bg img="cg/cg1_nagisa1.jpg"/>
    那里有个女生，和我一样呆呆地站着。
    看校徽的颜色，可以知道她也是三年级。
    不过，是一张陌生的面孔。
    披肩的短发，随着微风轻轻飘舞。
    <girl/>……
    <bg img="cg/cg1_nagisa2.jpg"/>
    嗯…嗯…
    ……
    <bg img="cg/cg1_nagisa3.jpg"/>
    你喜欢这所学校吗
    <tomoya/>哎…？
    <girl/>我非常非常地喜欢这里
    但是，所有的这一切…都在改变着
    不管是多么愉快的事，还是多么开心的事，所有这一切
    所有这一切，都在不断改变着
    <solo/>她有些笨拙地说着
    <girl/>即使这样，你还会永远喜欢这里吗？
    <solo/>……
    <girl/>我…
    <tomoya/>只要能找到不就行了吗
</MainPlot>
</FireML>
```
## FireML基本情况 ##
  * 格式完全符合XML规范。不要被XML吓到，因为所有复杂的事情都由开发者做完了，制作者只需要面对像上面那样简单的代码。
  * 设计原则：最常用的功能要写得快（所以对白就直接写纯文本）；复杂而较少使用的功能要易学和易读。
  * 支持整数、小数、布尔和字符串四种类型的变量，支持主要的算术和逻辑运算。FireML是弱类型化的。
  * 支持条件判断和循环两种流程控制方式。
  * 支持带参数和返回值的自定义函数。
  * 使用XML的原因，以及FireML的特色和使用技巧，FireML的一些高级用法（如表达式和变量），请见《天火脚本的设计动机》[FireMLMotivation](FireMLMotivation.md)。
## 预定义资源 ##
  * 可以将CG、音乐和视频定义为“预定义资源”，在调用时只需填写定义好的名称，而不必再写资源的完整路径。
  * “预定义资源”可以显示在“音乐欣赏”“CG欣赏”等界面中（下称Gallery），显示方式可以是：从不显示、玩家第一次看（听）到该资源时显示、始终显示。
  * “预定义资源”中记录了该资源的有关信息，如对于音乐，记录其标题、演唱者、作曲家等等，并能够在Gallery中显示。
  * 今后考虑将LRC歌词嵌入音乐资源中，通过对LRC歌词的解析，在Gallery中同步显示歌词。
## 代码提示和自动完成（IntelliSense） ##
  * 使用XML的最大好处就是能够利用现有编辑器实现代码提示和自动完成（就像Visual Studio或者Eclipse之类的集成开发环境那样），从而简化提高脚本编写效率。
  * 大概的样子是这样的：
> ![http://firefromheaven.googlecode.com/svn/wiki/attachments/demo.jpg](http://firefromheaven.googlecode.com/svn/wiki/attachments/demo.jpg)
  * 制作者自定义的函数也会被IntelliSense所支持。
  * 制作者设置的预定义资源会被IntelliSense所支持。当制作者输入到某个需要填写预定义资源内容的地方时，将会自动显示出相应类型的所有预定义资源列表以供选择。
  * XML语法错误以及部分逻辑错误将在编辑时实时地显示出来。（就像Word的拼写和语法检查那样）
## 运行前的脚本处理（编译） ##
  * 运行前的脚本处理，其实就是一个简单的编译器。可以认为FireML是编译执行的。所以，下面称运行前的脚本处理过程为“编译”，并称该处理程序为“编译器”。
  * 制作者所写的脚本中所含的错误，编译器会尽量找出来，而不是等到运行游戏时再报错。这些错误包括：
    * XML语法错误
    * 脚本逻辑错误，如函数名重复、调用了不存在的函数等
    * 表达式错误，如表达式语法错误，调用了未初始化的变量，数据类型错误等。
    * 脚本中引用的图像、音乐等资源不存在或不被支持
    * 脚本中引用的预定义资源从未定义过
    * 其它杂项错误
  * 编译器会将所有脚本文件编译成一个二进制文件供运行时调用。

# 图形系统 #
> 致力于满足AVG游戏的图形显示需求，主要包括:
  * 背景、立绘、头像、文字等基本元素的显示
  * 用户交互控件，包括按钮、选项框、滑动条等
  * 地图选择，即可以从一张地图上选择不同的地点以触发不同的剧情

# 动画和特效 #
  * 将支持背景和立绘的动画效果，基本动画主要包括移动、缩放、旋转、透明度变化等等。动画通过FireML定义。
  * 支持背景和立绘的切换效果（就像PPT那样）。可以通过制作像kiri的rules文件夹中那样的渐变图来自己定义切换效果。
  * 将利用XNA框架，通过DirectX来实现若干GPU实时计算的视觉特效，如雨雪、光影、粒子动画（火！）等。

# 可视化编辑 #
> 如果条件允许，计划开发几个简单的可视化编辑器，主要包括地图选择和动画的可视化编辑。

# 设计时面临的问题 #
  * 目前的最大问题是：由于XNA的限制，制作者必须要安装Visual C# Express（Visual Studio当然也可以）和XNA Game Studio才可以制作游戏。因为XNA必须要对其资源（图片、声音、视频、字体等）做预处理（类似于“编译”），而这一过程需要上面两个软件。对此，现在有一些解决方案，但工作量相当大。目前的设计已经考虑到为解决此问题留下扩展接口。具体请见《目前的窘境》。
  * 另一个问题是，怎样能让制作者自定义界面。一个理想的方案是模仿WPF，即用XML表示界面（看上去会有点像HTML），算作FireML的一部分，但是感觉开发难度太大。目前的权宜之计是：把界面中涉及到的图片路径和常量都存到文件（易读的XML格式）里，可供制作者修改，相当于实现了一定的自定义界面功能。

# 几点说明 #
  * 天火引擎的开发重点在于新型的脚本、智能和可视化的脚本编辑过程和丰富的视觉效果。因条件所限，天火引擎不太可能成为一个大规模的、功能非常完善的游戏引擎，短期内也不奢望能与kiri等竞争。
  * 天火引擎有比较鲜明的模块化特点，而且有一些与主程序分离的小工具（如可视化编辑器等），便于分工合作。所以，如果你对这个开源项目感兴趣，欢迎和我联系。